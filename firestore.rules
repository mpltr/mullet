rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the owner of a document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Note: Removed isHomeMember helper to avoid circular dependency
    // Home membership is now checked directly in each rule
    
    // Note: Removed isHomeOwner helper to avoid circular dependency
    // Home ownership is now checked directly in each rule where the resource is available
    
    // Helper function to check if user is authorized for tasks/rooms
    function isAuthorizedUser(authorizedUsers) {
      return isAuthenticated() && request.auth.uid in authorizedUsers;
    }

    // Users collection - users can read/write their own data
    match /users/{userId} {
      allow read, write: if isOwner(userId);
      
      // Allow other authenticated users to read basic user info
      allow read: if isAuthenticated();
    }

    // Homes collection
    match /homes/{homeId} {
      // Any authenticated user can read basic home info (needed for invitations)
      // Write operations are still restricted to members/owners
      allow read: if isAuthenticated();
      
      // Only authenticated users can create homes
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.createdBy &&
                       request.auth.uid in request.resource.data.members;
      
      // Home owners can update home data
      // OR users can add themselves to members (accepting invitation)
      // OR users can remove themselves from members (leaving home)
      allow update: if isAuthenticated() && 
                       (request.auth.uid == resource.data.createdBy ||
                        (request.auth.uid in request.resource.data.members &&
                         !(request.auth.uid in resource.data.members)) ||
                        (request.auth.uid in resource.data.members &&
                         !(request.auth.uid in request.resource.data.members)));
      
      // Only home owners can delete homes
      allow delete: if isAuthenticated() && 
                       request.auth.uid == resource.data.createdBy;
    }

    // Rooms collection
    match /rooms/{roomId} {
      // Users can read rooms if they're authorized
      allow read: if isAuthenticated() && 
                     request.auth.uid in resource.data.authorizedUsers;
      
      // Users can create rooms if they're authorized (assumes proper authorization setup)
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.authorizedUsers;
      
      // Users can update/delete rooms if they're authorized
      allow update, delete: if isAuthenticated() && 
                               isAuthorizedUser(resource.data.authorizedUsers);
    }

    // Tasks collection
    match /tasks/{taskId} {
      // Users can read tasks if they're authorized
      allow read: if isAuthenticated() && 
                     request.auth.uid in resource.data.authorizedUsers;
      
      // Users can create tasks if they're authorized and the creator
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.authorizedUsers &&
                       request.auth.uid == request.resource.data.createdBy;
      
      // Users can update tasks if they're authorized
      allow update: if isAuthenticated() && 
                       isAuthorizedUser(resource.data.authorizedUsers);
      
      // Only task creators can delete tasks (home owner delete handled by app logic)
      allow delete: if isAuthenticated() && 
                       request.auth.uid == resource.data.createdBy;
    }

    // Home invitations collection
    match /home_invitations/{inviteId} {
      // Users can read invitations where they are the invitee or inviter
      allow read: if isAuthenticated() && 
                     (request.auth.token.email == resource.data.invitedEmail ||
                      request.auth.uid == resource.data.invitedBy);
      
      // Only authenticated users can create invitations (app logic ensures proper home membership)
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.invitedBy &&
                       request.resource.data.status == 'pending';
      
      // Invited users can update invitation status (accept/decline)
      // Inviters can also update (revoke)
      allow update: if isAuthenticated() && 
                       (request.auth.token.email == resource.data.invitedEmail ||
                        request.auth.uid == resource.data.invitedBy);
      
      // Invited users and inviters can delete invitations
      allow delete: if isAuthenticated() && 
                       (request.auth.token.email == resource.data.invitedEmail ||
                        request.auth.uid == resource.data.invitedBy);
    }
  }
}